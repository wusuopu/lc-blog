
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>龍昌博客</title>
  <meta name="author" content="龍昌">

  
  <meta name="description" content="MongoEngine在进行数据操作时会发出一些信号，我们可以连接这些信号进行一些额外的操作。注意：要在MongoEngine中使用信号，需要安装 blinker 这个库。 $ pip install blinker MongoEngine提供的信号如下： pre_init: 在创建一个新的 &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://www.xefan.com/page/6/index.html">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="龍昌博客" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//lib.sinaapp.com/js/jquery/1.9.1/jquery-1.9.1.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<!--<link href="//fonts.useso.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">&#8211;>
<!--<link href="//fonts.useso.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">&#8211;>

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">龍昌博客</a></h1>
  
    <h2>从Pythoneer转向Rubist</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:www.xefan.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Home</a></li>
  <li><a href="/blog/archives">Archives</a></li>
 <li><a href="/about/">About</a></li>  <li><a href="/gbook/">留言板</a></li> 
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
    <h1 class="entry-title"><a href="http://www.xefan.com/archives/84076.html">Mongoengine教程(5)——信号</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2014-04-06T00:00:00+08:00'><span class='date'><span class='date-month'>Apr</span> <span class='date-day'>6</span><span class='date-suffix'>th</span>, <span class='date-year'>2014</span></span> <span class='time'>12:00 am</span></time>
        
           | <a href="http://www.xefan.com/archives/84076.html#disqus_thread"
             data-disqus-identifier="http://www.xefan.com/archives/84076.html">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>MongoEngine在进行数据操作时会发出一些信号，我们可以连接这些信号进行一些额外的操作。注意：要在MongoEngine中使用信号，需要安装 <em>blinker</em> 这个库。  </p>


<pre><code>$ pip install blinker
</code></pre>


<p>MongoEngine提供的信号如下：  </p>


<ul>
<li>pre_init: 在创建一个新的 Document 或者 EmbeddedDocument 实例对象之后，并且对象初始化之前调用。  </li>
<li>post_init:在 Document 或者 EmbeddedDocument 实例对象初始化完成之后调用。  </li>
<li>pre_save:在 save 方法执行之前调用。  </li>
<li>pre_save_post_validation:在数据检验完成之后，数据保存之前调用。  </li>
<li>post_save:在数据保存完成之后调用。  </li>
<li>pre_delete:在 delete 方法执行之前调用。  </li>
<li>post_delete:在记录成功删除之后调用。  </li>
<li>pre_bulk_insert:在数据检验之后，数据插入之前调用。  </li>
<li>post_bulk_insert:在数据成功插入之后调用。</li>
</ul>


<h2>事件连接</h2>


<p>使用 signals 将信号与回调函数进行连接。</p>


<pre><code>from mongoengine import *
from mongoengine import signals

class Author(Document):
    name = StringField()

    @classmethod
    def pre_save(cls, sender, document, **kwargs):
        print("Pre Save: %s" % document.name)

    @classmethod
    def post_save(cls, sender, document, **kwargs):
        print("Post Save: %s" % document.name)
        if 'created' in kwargs:
            if kwargs['created']:
                print("Created")
            else:
                print("Updated")

signals.pre_save.connect(Author.pre_save, sender=Author)
signals.post_save.connect(Author.post_save, sender=Author)
</code></pre>


<p>注意：对于 RefereneField 的<em>reverse_delete_rules</em>参数不会触发信号。</p>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
    <h1 class="entry-title"><a href="http://www.xefan.com/archives/84072.html">Mongoengine教程(4)——文件存储</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2014-04-05T00:00:00+08:00'><span class='date'><span class='date-month'>Apr</span> <span class='date-day'>5</span><span class='date-suffix'>th</span>, <span class='date-year'>2014</span></span> <span class='time'>12:00 am</span></time>
        
           | <a href="http://www.xefan.com/archives/84072.html#disqus_thread"
             data-disqus-identifier="http://www.xefan.com/archives/84072.html">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>MongoDB的GridFS支持直接在数据库中存储文件。要在MongoEngine中使用GridFS，只要使用 FileField 对象即可。以下是一个例子：</p>


<pre><code>class Animal(Document):
    genus = StringField()
    family = StringField()
    photo = FileField()

marmot = Animal(genus='Marmota', family='Sciuridae')

marmot_photo = open('gtk.png', 'rb')
marmot.photo.put(marmot_photo, content_type = 'image/png')
marmot.save()
</code></pre>


<p>这个例子将 gtk.png 这个图片存入了数据库中。<br>
文件的读取也很简单：</p>


<pre><code>marmot = Animal.objects(genus='Marmota').first()
photo = marmot.photo.read()
content_type = marmot.photo.content_type
</code></pre>


<p>FileField不仅可以存储文件，还可以用来存储数据流。只是操作上略微不同。</p>


<p>要存储数据流，首先先创建一个新的文件，然后再往里面写入数据。</p>


<pre><code>marmot.photo.new_file()
marmot.photo.write('some_image_data')
marmot.photo.write('some_more_image_data')
marmot.photo.close()
marmot.save()
</code></pre>


<p>如果要删除存储在数据库中的文件，只需要调用该文件对象的 delete 方法：</p>


<pre><code>marmot.photo.delete()
</code></pre>


<p>注意：一条文档记录中的FileField字段只保存了对GridFS集合中该文件的ID引用。这意味着如果该文档被删除了，对用的文件不会被删除。因此在删除这类文档时需要小心，以免出现孤立文件。</p>


<p>对于已存储的文件可以进行替换修改：</p>


<pre><code>another_marmot = open('python.png', 'rb')
marmot.photo.replace(another_marmot, content_type='image/png')
</code></pre>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
    <h1 class="entry-title"><a href="http://www.xefan.com/archives/84069.html">Mongoengine教程(3)——数据查询</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2014-04-05T00:00:00+08:00'><span class='date'><span class='date-month'>Apr</span> <span class='date-day'>5</span><span class='date-suffix'>th</span>, <span class='date-year'>2014</span></span> <span class='time'>12:00 am</span></time>
        
           | <a href="http://www.xefan.com/archives/84069.html#disqus_thread"
             data-disqus-identifier="http://www.xefan.com/archives/84069.html">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>与Django一样，Document类都有一个 objects 属性。它用于将类与数据库关联起来。objects属性是一个QuerySetManager类型的对象，它的操作会返回一个QuerySet类型的对象。可以通过对QuerySet对象的迭代获取数据库中的数据。</p>


<pre><code>class User(Document):
    name = StringField()
    country = StringField()

class Paper(Document):
    content = StringField()
    author = ReferenceField(User)
</code></pre>


<h2>查询过滤</h2>


<p>可以在查询是指定过滤条件以获取想要的结果。例如想要查询英国的用户：</p>


<pre><code>uk_users = User.objects(country='uk')
</code></pre>


<p>与Django类似，要查询引用的对象只需要使用双下划线即可。例如想要查询英国用户的论文：</p>


<pre><code>uk_papers = Paper.objects(author__country='uk')
</code></pre>


<h2>查询操作</h2>


<p>与Django类似，MongoEngine同样也提供了一些条件语句。</p>


<ul>
<li>ne - 不相等</li>
<li>lt - 小于</li>
<li>lte - 小于等于</li>
<li>gt - 大于</li>
<li>gte - 大于等于</li>
<li>not - 取反</li>
<li>in - 值在列表中</li>
<li>nin - 值不在列表中</li>
<li>mod - 取模</li>
<li>all - 与列表的值相同</li>
<li>size - 数组的大小</li>
<li>exists - 字段的值存在</li>
</ul>


<p>例如查询年龄小于等于18岁的用户：</p>


<pre><code>young_users = Users.objects(age__lte=18)
</code></pre>


<p>对于不同类型的数据提供了不同的条件语句。</p>


<h3>查询结果个数限制</h3>


<p>跟传统的ORM一样，MongoEngine也可以限制查询结果的个数。一种方法是在QuerySet对象上调用limit和skip方法；另一种方法是使用数组的分片的语法。例如：</p>


<pre><code>users = User.objects[10:15]
users = User.objects.skip(10).limit(5)
</code></pre>


<h2>聚合操作</h2>


<p>MongoEngine提供了一些数据库的聚合操作。</p>


<p>统计结果个数即可以使用QuerySet的count方法，也可以使用Python风格的方法：</p>


<pre><code>num_users = len(User.objects)
num_users = User.objects.count()
</code></pre>


<p>其他的一些聚合操作。<br>
求和：</p>


<pre><code>yearly_expense = Employee.objects.sum('salary')
</code></pre>


<p>求平均数：</p>


<pre><code>mean_age = User.objects.average('age')
</code></pre>


<h2>高级查询</h2>


<p>有时需要将多个条件进行组合，前面提到的方法就不能满足需求了。这时可以使用MongoEngine的Q类。它可以将多个查询条件进行 &amp;(与) 和 |(或) 操作。</p>


<p>例如下面的语句是查询所有年龄大于等于18岁的英国用户，或者所有年龄大于等于20岁的用户。</p>


<pre><code>User.objects((Q(country='uk') &amp; Q(age__gte=18)) | Q(age__gte=20))
</code></pre>


<h2>在服务器端执行javascript代码</h2>


<p>通过MongoEngine QuerySet对象的 exec_js 方法可以将javascript代码作为字符串发送给服务器端执行，然后返回执行的结果。</p>


<p>例如查询该数据库都有那些集合：</p>


<pre><code>User.objects.exec_js("db.getCollectionNames()")
</code></pre>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
    <h1 class="entry-title"><a href="http://www.xefan.com/archives/84066.html">Mongoengine教程(2)——文档模式</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2014-04-03T00:00:00+08:00'><span class='date'><span class='date-month'>Apr</span> <span class='date-day'>3</span><span class='date-suffix'>rd</span>, <span class='date-year'>2014</span></span> <span class='time'>12:00 am</span></time>
        
           | <a href="http://www.xefan.com/archives/84066.html#disqus_thread"
             data-disqus-identifier="http://www.xefan.com/archives/84066.html">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>在MongoDB中一个文档(document)与关系型数据库中的一行(row)相似；文档保存在集合(collection)中，行保存在表(table)中。</p>


<h2>定义文档的模式</h2>


<p>与django类似，要定义一个文档模式只需要创建一个类继承自 Document，并添加一些 Field 对象。</p>


<pre><code>from mongoengine import *
import datetime

class Page(Document):
    title = StringField(max_length=200, required=True)
    date_modified = DateTimeField(default=datetime.datetime.now)
</code></pre>


<p>如上定义了一个文档模式具有 title和date_modified 两个字段。</p>


<p>同时MongoDB本身就是无模式的，因此我们还可以创建动态的文档模式。它可以在添加数据时为不同的数据设置不同的字段。</p>


<pre><code>class Page(DynamicDocument):
    title = StringField(max_length=200, required=True)
</code></pre>


<p>添加数据：</p>


<pre><code>page = Page(title='Using MongoEngine')
page.tags = ['mongodb', 'mongoengine']
page.save()
</code></pre>


<h2>文档字段</h2>


<p>文档字段(Field)不是必需的，但是使用它来进行数据验证、设置默认值等操作会比较方便。</p>


<p>MongoEngine提供了如下这些类型的Field:</p>


<ul>
<li>BinaryField  </li>
<li>BooleanField  </li>
<li>ComplexDateTimeField  </li>
<li>DateTimeField  </li>
<li>DecimalField  </li>
<li>DictField  </li>
<li>DynamicField  </li>
<li>EmailField  </li>
<li>EmbeddedDocumentField  </li>
<li>FileField  </li>
<li>FloatField  </li>
<li>GenericEmbeddedDocumentField  </li>
<li>GenericReferenceField  </li>
<li>GeoPointField  </li>
<li>ImageField  </li>
<li>IntField  </li>
<li>ListField  </li>
<li>MapField  </li>
<li>ObjectIdField  </li>
<li>ReferenceField  </li>
<li>SequenceField  </li>
<li>SortedListField  </li>
<li>StringField  </li>
<li>URLField  </li>
<li>UUIDField  </li>
</ul>


<h2>文档之间引用关系</h2>


<p>在关系型数据库中多个表可以使用外键进行关联。然而MongoDB是无模式的，因此想要达到这样的效果就这能在应用程序中自己手动的进行关联了。</p>


<p>不过还好，使用MongoEngine的ReferenceField可以很方便的实现。</p>


<pre><code>class User(Document):
    name = StringField()

class Page(Document):
    content = StringField()
    author = ReferenceField(User)

john = User(name="John Smith")
john.save()

post = Page(content="Test Page")
post.author = john
post.save()
</code></pre>


<h3>一对多的关系</h3>


<p>对于一对多的关系可以使用ListField来保存一个ReferenceField列表。在进行查询操作是需要传入一个实例对象。</p>


<pre><code>class User(Document):
    name = StringField()

class Page(Document):
    content = StringField()
    authors = ListField(ReferenceField(User))

bob = User(name="Bob Jones").save()
john = User(name="John Smith").save()

Page(content="Test Page", authors=[bob, john]).save()
Page(content="Another Page", authors=[john]).save()

# Find all pages Bob authored
Page.objects(authors__in=[bob])
</code></pre>


<h3>引用对象的删除操作</h3>


<p>MongoDB默认不会检查数据的完整性，因此在删除一个对象是就需要自己手动的处理引用了该对象的其他对象。</p>


<p>同样的MongoEngine也提供了一样的功能。ReferenceField有一个 reverse_delete_rule 参数可以进行设置。它的取值如下：  </p>


<ul>
<li>mongoengine.DO_NOTHING:默认就是这个值，它不会进行任何操作。  </li>
<li>mongoengine.DENY:如果该对象还被其他对象引用，则拒绝删除。  </li>
<li>mongoengine.NULLIFY:将其他对象对该对象的引用字段设为null。  </li>
<li>mongoengine.CASCADE:将引用了该对象的其他对象也删除掉。  </li>
<li>mongoengine.PULL:移除对该对象的引用。  </li>
</ul>


<h2>索引</h2>


<p>与django的Model相似，MongoEngine的Document也可以在meta属性中设置索引。</p>


<pre><code>class Page(Document):
    title = StringField()
    rating = StringField()
    meta = {
        'indexes': ['title', ('title', '-rating')]
    }
</code></pre>


<p>meta中的indexes可以是一个列表，也可以是一个字典。</p>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
    <h1 class="entry-title"><a href="http://www.xefan.com/archives/84063.html">Mongoengine教程(1)——概述</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2014-04-02T00:00:00+08:00'><span class='date'><span class='date-month'>Apr</span> <span class='date-day'>2</span><span class='date-suffix'>nd</span>, <span class='date-year'>2014</span></span> <span class='time'>12:00 am</span></time>
        
           | <a href="http://www.xefan.com/archives/84063.html#disqus_thread"
             data-disqus-identifier="http://www.xefan.com/archives/84063.html">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>MongoEngine是MongoDB的一个ODM(Object-Document Mapper)框架，它提供了类似Django的语法来操作MongoDB数据库。</p>


<h2>安装</h2>


<p>安装 MongoEngine 需要先安装 PyMongo。  </p>


<h3>使用pip安装</h3>


<pre><code>$ [sudo] pip install mongoengine
</code></pre>


<h3>通过源代码安装</h3>


<p>先从 <a href="http://pypi.python.org/pypi/mongoengine/">PyPi</a> 或者 <a href="http://github.com/MongoEngine/mongoengine">Github</a> 下载源代码。然后再进行安装。</p>


<pre><code>$ [sudo] python setup.py install
</code></pre>


<h2>使用</h2>


<p>首先启动 mongodb 服务器：</p>


<pre><code>$ mongod
</code></pre>


<h3>连接服务器</h3>


<p>使用 connect 方法进行数据库链接，与pymongo的用法相似，其参数可以是多种型式的。</p>


<pre><code>from mongoengine import connect
connect('project1')
connect('project1', host='mongodb://localhost:27017/test_database')
</code></pre>


<p>从 MongoEngine 0.6 开始增加了多数据库的支持， connect 的第二个参数可以为每个链接设置一个别名。</p>


<h3>定义数据模型</h3>


<p>mongoengine的 Document 与django的 Model 相似。</p>


<pre><code>class User(mongoengine.Document):
    name = mongoengine.StringField()

    meta = {"db_alias": "default"}
</code></pre>


<h3>数据操作</h3>


<p>数据的添加过程也与django相似：</p>


<pre><code>User.objects.create(name="test1")
User.objects.create(name="test2")
User(name="test3").save()
</code></pre>


<p>查询数据：</p>


<pre><code>User.objects.filter(name="test2")
</code></pre>


<p>删除数据：</p>


<pre><code>User.objects.filter(name="test2").delete()
</code></pre>


<p>MongoEngine虽然提供了ODM，但是我们同样还是可以直接对数据库进行操作。<br>
获取 pymongo 的 collection 对象：</p>


<pre><code>User.objects._collection
</code></pre>


<p>然后就可以使用原生的pymongo操作了。</p>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
    <h1 class="entry-title"><a href="http://www.xefan.com/archives/84060.html">Pymongo教程(3)——自定义数据类型</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2014-03-30T00:00:00+08:00'><span class='date'><span class='date-month'>Mar</span> <span class='date-day'>30</span><span class='date-suffix'>th</span>, <span class='date-year'>2014</span></span> <span class='time'>12:00 am</span></time>
        
           | <a href="http://www.xefan.com/archives/84060.html#disqus_thread"
             data-disqus-identifier="http://www.xefan.com/archives/84060.html">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>pymongo提供一些常用的数据类型，如：数据、字符串、日期等。如果感觉还不能满足需求，那么还可以自定义数据类型。</p>


<p>首先定义一个类：</p>


<pre><code>class Custom(object):
    def __init__(self, x):
        self.__x = x

    def x(self):
        return self.__x
</code></pre>


<p>要将自定义类型的数据存入数据库中需要先进行编码；将数据从数据库读取出来后又需要再解码。</p>


<h2>手动编码/解码</h2>


<p>我们可以定义两个方法，在插入和查询数据时进行手动的编码、解码。</p>


<pre><code>def encode_custom(custom):
    return {"_type": "custom", "x": custom.x()}

def decode_custom(document):
    assert document["_type"] == "custom"
    return Custom(document["x"])

print(db.test.insert({"custom": encode_custom(Custom(5))}))
print(db.test.find_one()['custom'])
</code></pre>


<h2>自动编码/解码</h2>


<p>手动地进行编码虽然可行，但是还是不太方便。我们还可以使用 SONManipulator 进行自动编码。</p>


<pre><code>from pymongo.son_manipulator import SONManipulator
class Transform(SONManipulator):
    def transform_incoming(self, son, collection):
        for (key, value) in son.items():
            if isinstance(value, Custom):
                son[key] = encode_custom(value)
            elif isinstance(value, dict): # Make sure we recurse into sub-docs
                son[key] = self.transform_incoming(value, collection)
        return son

    def transform_outgoing(self, son, collection):
        for (key, value) in son.items():
            if isinstance(value, dict):
                if "_type" in value and value["_type"] == "custom":
                    son[key] = decode_custom(value)
                else: # Again, make sure to recurse into sub-docs
                    son[key] = self.transform_outgoing(value, collection)
        return son

db.add_son_manipulator(Transform())
print(db.test.insert({"custom": Custom(5)}))
print(db.test.find_one())
</code></pre>


<h2>二进制编码</h2>


<p>我们也可以将其编码成二进制进行存储。</p>


<pre><code>from bson.binary import Binary
def to_binary(custom):
    return Binary(str(custom.x()), 128)

def from_binary(binary):
    return Custom(int(binary))

class TransformToBinary(SONManipulator):
    def transform_incoming(self, son, collection):
        for (key, value) in son.items():
            if isinstance(value, Custom):
                son[key] = to_binary(value)
            elif isinstance(value, dict):
                son[key] = self.transform_incoming(value, collection)
        return son

    def transform_outgoing(self, son, collection):
        for (key, value) in son.items():
            if isinstance(value, Binary) and value.subtype == 128:
                son[key] = from_binary(value)
            elif isinstance(value, dict):
                son[key] = self.transform_outgoing(value, collection)
        return son

db.add_son_manipulator(TransformToBinary())
print(db.test.insert({"custom": Custom(5)}))
print(db.test.find_one())
</code></pre>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
    <h1 class="entry-title"><a href="http://www.xefan.com/archives/84057.html">Pymongo教程(2)——聚合操作</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2014-03-29T00:00:00+08:00'><span class='date'><span class='date-month'>Mar</span> <span class='date-day'>29</span><span class='date-suffix'>th</span>, <span class='date-year'>2014</span></span> <span class='time'>12:00 am</span></time>
        
           | <a href="http://www.xefan.com/archives/84057.html#disqus_thread"
             data-disqus-identifier="http://www.xefan.com/archives/84057.html">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>在MongoDB中常用的聚合操作有 aggregation、map/reduce和group 。</p>


<p>首先先添加一些测试数据：</p>


<pre><code>db.things.insert({"x": 1, "tags": ["dog", "cat"]})
db.things.insert({"x": 2, "tags": ["cat"]})
db.things.insert({"x": 2, "tags": ["mouse", "cat", "dog"]})
db.things.insert({"x": 3, "tags": []})
</code></pre>


<h2>aggregation</h2>


<p>以下例子是统计 tags 字段内的各个值的出现的次数。</p>


<pre><code>from bson.son import SON
db.things.aggregate([
    {"$unwind": "$tags"},
    {"$group": {"_id": "$tags", "count": {"$sum": 1}}},
    {"$sort": SON([("count", -1), ("_id", -1)])}
])

{'ok': 1.0, 'result': [{'count': 3, '_id': 'cat'}, {'count': 2, '_id': 'dog'}, {'count': 1, '_id': 'mouse'}]}
</code></pre>


<p>注意：aggregate操作要求服务器程序为 2.1.0 以上的版本。PyMongo 驱动程序为 2.3 以上的版本。</p>


<h2>Map/Reduce</h2>


<p>上面的操作同样也可以使用 Map/Reduce 完成。</p>


<pre><code>from bson.code import Code
mapper = Code("""
    function () {
      this.tags.forEach(function(z) {
        emit(z, 1);
      });
    }
""")

reducer = Code("""
    function (key, values) {
      var total = 0;
      for (var i = 0; i &lt; values.length; i++) {
        total += values[i];
      }
      return total;
    }
""")

result = db.things.map_reduce(mapper, reducer, "myresults")
for doc in result.find():
    print(doc)

{u'_id': u'cat', u'value': 3.0}
{u'_id': u'dog', u'value': 2.0}
{u'_id': u'mouse', u'value': 1.0}
</code></pre>


<p>map和reduce都是一个javascript的函数； map_reduce 方法会将统计结果保存到一个临时的数据集合中。</p>


<h2>Group</h2>


<p>group 操作与SQL的 GROUP BY 相似，同时比 Map/Reduce 要简单。</p>


<pre><code>reducer = Code("""
    function(obj, prev){
      prev.count++;
    }
""")

results = db.things.group(key={"x":1}, condition={}, initial={"count": 0}, reduce=reducer)
for doc in results:
    print(doc)

{'x': 1.0, 'count': 1.0}
{'x': 2.0, 'count': 2.0}
{'x': 3.0, 'count': 1.0}
</code></pre>


<p>注意：在MongoDB的集群环境中不支持 group 操作，可以使用 aggregation 或者 map/reduce 代替。</p>


<p>完整的MongoDB聚合文档： http://docs.mongodb.org/manual/aggregation/</p>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
    <h1 class="entry-title"><a href="http://www.xefan.com/archives/84053.html">Pymongo教程(1)——概述</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2014-03-29T00:00:00+08:00'><span class='date'><span class='date-month'>Mar</span> <span class='date-day'>29</span><span class='date-suffix'>th</span>, <span class='date-year'>2014</span></span> <span class='time'>12:00 am</span></time>
        
           | <a href="http://www.xefan.com/archives/84053.html#disqus_thread"
             data-disqus-identifier="http://www.xefan.com/archives/84053.html">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>MongoDB是使用C++开发的一款文档型数据库，PyMongo是MongoDB的Python驱动。</p>


<h2>安装</h2>


<h3>使用pip安装</h3>


<pre><code>$ [sudo] pip install pymongo
</code></pre>


<p>如果要安装特定的版本则：</p>


<pre><code>$ [sudo] pip install pymongo==2.6.3
</code></pre>


<h3>通过源代码安装</h3>


<pre><code>$ git clone git://github.com/mongodb/mongo-python-driver.git pymongo
$ cd pymongo/
$ [sudo] python setup.py install
</code></pre>


<p>注意：使用C的扩展会对性能提升会有帮助。但是在uwsgi中会出现警告，则可以选择只安装python驱动，而不安装C扩展。</p>


<pre><code>$ [sudo] python setup.py --no_ext install
</code></pre>


<p>注意： 如果你使用的是Python3的话，PyMongo只支持 Python 3.1以上的版本。</p>


<h2>使用</h2>


<p>首先启动 mongodb 服务器：</p>


<pre><code>$ mongod
</code></pre>


<h3>连接服务器</h3>


<p>然后执行python程序连接服务器：</p>


<pre><code>from pymongo import MongoClient
client = MongoClient()
</code></pre>


<p>以上会连接到默认的主机和端口（localhost:27017），也可以指定主机名和端口：</p>


<pre><code>client = MongoClient('localhost', 27017)
</code></pre>


<p>或者：</p>


<pre><code>client = MongoClient('mongodb://localhost:27017/')
</code></pre>


<h3>访问数据库</h3>


<pre><code>db = client.test_database
</code></pre>


<p>如果数据库的名称不能直接使用属性名的风格访问，那么就需要使用字典的风格：</p>


<pre><code>db = client['test-database']
</code></pre>


<h3>访问数据集合</h3>


<p>与访问数据库相似：</p>


<pre><code>collection = db.test_collection
collection = db['test-collection']
</code></pre>


<h3>插入数据</h3>


<p>在MongoDB中数据是以类似JSON格式进行保存的，在PyMongo中则是使用字典风格。然后可以数据集合对象的 insert() 方法进行插入数据。</p>


<pre><code>import datetime
post = {"author": "Mike",
        "text": "My first blog post!",
        "tags": ["mongodb", "python", "pymongo"],
        "date": datetime.datetime.utcnow()}
post_id = db.posts.insert(post)
</code></pre>


<h3>查询数据</h3>


<p>可以数据集合对象的 find() 方法进行查询数据。</p>


<pre><code>db.posts.find({"author": "Mike"})
db.posts.find_one({"author": "Mike"})
</code></pre>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
    <h1 class="entry-title"><a href="http://www.xefan.com/archives/84048.html">自动生成.gitignore文件</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2014-03-07T00:00:00+08:00'><span class='date'><span class='date-month'>Mar</span> <span class='date-day'>7</span><span class='date-suffix'>th</span>, <span class='date-year'>2014</span></span> <span class='time'>12:00 am</span></time>
        
           | <a href="http://www.xefan.com/archives/84048.html#disqus_thread"
             data-disqus-identifier="http://www.xefan.com/archives/84048.html">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>.gitignore文件是用于对git进行设置，让其忽略对某些文件的跟踪。</p>


<p>最近发现每创建一个新的仓库都要把.gitignore文件重新写一遍，甚是麻烦。于是就想能否自动生成.gitignore文件，这样的话就比较方便。最后找到了 gitignore.io 这个网站，它可以根据需求生成相应的.gitignore文件。比较你是用vim编辑器编写python代码，则输入vim  python就会生成对应vim和python的gitignore文件了。</p>


<p>为了方便使用我编写了一个shell脚本。从 https://gist.github.com/wusuopu/9408486 下载代码，保存为mkgitignore，并加上执行权限。然后执行如下命令生成.gitignore文件。</p>


<pre><code>$ mkgitignore vim,python
$ mkgitignore vim,python .gitignore
</code></pre>


<p>第一条命令是直接将结果输出到终端，第二条命令是将结果输出到.gitignore文件中。</p>


<p>最后补充一个git的小知识：<br>
如果想要在所有的项目中都忽略掉某些文件的话，那么可以设置一个全局的gitignore。执行如下命令：</p>


<pre><code>$ git config --global core.excludesfile ~/.gitignore
</code></pre>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
    <h1 class="entry-title"><a href="http://www.xefan.com/archives/84045.html">Linux下VNC使用</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2014-03-01T00:00:00+08:00'><span class='date'><span class='date-month'>Mar</span> <span class='date-day'>1</span><span class='date-suffix'>st</span>, <span class='date-year'>2014</span></span> <span class='time'>12:00 am</span></time>
        
           | <a href="http://www.xefan.com/archives/84045.html#disqus_thread"
             data-disqus-identifier="http://www.xefan.com/archives/84045.html">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><h3>安装</h3>


<p>VNC (Virtual Network Computer)是虚拟网络计算机的缩写。VNC 是一款优秀的远程控制工具软件。<br>
VNC程序有多个软件包可选择，例如执行以下命令进行安装：</p>


<pre><code>$ sudo apt-get install vnc4server
$ sudo pacman -S tigervnc
</code></pre>


<h3>启动服务器程序</h3>


<p>修改$HOME/.vnc/xstartup配置文件，我是用的xfce，配置如下：</p>


<pre><code>#!/bin/sh

# Uncomment the following two lines for normal desktop:
# unset SESSION_MANAGER
# exec /etc/X11/xinit/xinitrc

[ -x /etc/vnc/xstartup ] &amp;&amp; exec /etc/vnc/xstartup
[ -r $HOME/.Xresources ] &amp;&amp; xrdb $HOME/.Xresources
xsetroot -solid grey
vncconfig -iconic &amp;
startxfce4 &amp;
</code></pre>


<p>然后运行服务程序，首次运行需要先设置密码：</p>


<pre><code>$ vncserver
</code></pre>


<h3>启动客户端程序</h3>


<p>执行如下命令链接vnc服务：</p>


<pre><code>$ vncviewer &lt;host&gt;:&lt;DISPLAY&gt;
</code></pre>


<p>例如要链接到10.0.0.101的1号DISPLAY，则是：</p>


<pre><code>$ vncviewer 10.0.0.101:1
</code></pre>


<p>然后根据提示输入密码即可。</p>


<h3>退出程序</h3>


<p>如果要退出客户端程序，直接将程序窗口关闭即可。<br>
如果要退出服务端程序，则在服务端执行命令：  </p>


<pre><code>$ vncserver -kill :1
</code></pre>

</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/page/7">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
    <a class="next" href="/page/5">Newer &rarr;</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Subscription</h1>
  <!--以下是QQ邮件列表订阅嵌入代码--><script >var nId = "e7ee5da6d322dc7157c25cfd8a7700bb23a056dd1fb18cb4",nWidth="auto",sColor="light",sText="请输入邮件地址：" ;</script><script src="http://list.qq.com/zh_CN/htmledition/js/qf/page/qfcode.js" charset="gb18030"></script>
</section>
<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="http://www.xefan.com/archives/84166.html">通过串口连接raspberry Pi</a>
      </li>
    
      <li class="post">
        <a href="http://www.xefan.com/archives/84165.html">使用CodePush对ReactNative进行热更新</a>
      </li>
    
      <li class="post">
        <a href="http://www.xefan.com/archives/84164.html">ReactNative获取设备屏幕尺寸</a>
      </li>
    
      <li class="post">
        <a href="http://www.xefan.com/archives/84163.html">ReactNative Jsbundle管理</a>
      </li>
    
      <li class="post">
        <a href="http://www.xefan.com/archives/84162.html">ReactNative自动设置开发服务器IP</a>
      </li>
    
  </ul>
</section>
<section>
  <h1>Categories</h1>
    <ul id="category-list"><li><a href='/categories/linux栏目/index.html'>linux栏目 (48)</a></li><li><a href='/categories/python栏目/index.html'>python栏目 (34)</a></li><li><a href='/categories/ruby栏目/index.html'>ruby栏目 (32)</a></li><li><a href='/categories/web开发/index.html'>web开发 (20)</a></li><li><a href='/categories/前端相关/index.html'>前端相关 (10)</a></li><li><a href='/categories/嵌入式栏目/index.html'>嵌入式栏目 (12)</a></li><li><a href='/categories/开源软件/index.html'>开源软件 (20)</a></li><li><a href='/categories/教程/index.html'>教程 (16)</a></li><li><a href='/categories/数据库/index.html'>数据库 (10)</a></li><li><a href='/categories/数据结构和算法/index.html'>数据结构和算法 (16)</a></li><li><a href='/categories/编程开发/index.html'>编程开发 (43)</a></li><li><a href='/categories/网络日志/index.html'>网络日志 (11)</a></li><li><a href='/categories/资源分享/index.html'>资源分享 (24)</a></li></ul>
</section>
<section>
  <h1>Tag Cloud</h1>
    <span id="tag-cloud"><a href='/tags/access/index.html' style='font-size: 105.3731343283582%'>access(6)</a> <a href='/tags/adobe/index.html' style='font-size: 100.8955223880597%'>adobe(1)</a> <a href='/tags/ajax/index.html' style='font-size: 102.68656716417911%'>ajax(3)</a> <a href='/tags/android/index.html' style='font-size: 100.8955223880597%'>Android(1)</a> <a href='/tags/angular/index.html' style='font-size: 106.26865671641791%'>angular(7)</a> <a href='/tags/apache/index.html' style='font-size: 100.8955223880597%'>apache(1)</a> <a href='/tags/arch/index.html' style='font-size: 106.26865671641791%'>Arch(7)</a> <a href='/tags/arm/index.html' style='font-size: 107.16417910447761%'>ARM(8)</a> <a href='/tags/asp/index.html' style='font-size: 106.26865671641791%'>asp(7)</a> <a href='/tags/c/index.html' style='font-size: 111.64179104477611%'>C(13)</a> <a href='/tags/css/index.html' style='font-size: 101.7910447761194%'>css(2)</a> <a href='/tags/django/index.html' style='font-size: 102.68656716417911%'>Django(3)</a> <a href='/tags/dreamweaver/index.html' style='font-size: 100.8955223880597%'>Dreamweaver(1)</a> <a href='/tags/fedora/index.html' style='font-size: 101.7910447761194%'>Fedora(2)</a> <a href='/tags/firefox/index.html' style='font-size: 102.68656716417911%'>firefox(3)</a> <a href='/tags/flash/index.html' style='font-size: 100.8955223880597%'>Flash(1)</a> <a href='/tags/ftp/index.html' style='font-size: 100.8955223880597%'>ftp(1)</a> <a href='/tags/gcc/index.html' style='font-size: 105.3731343283582%'>gcc(6)</a> <a href='/tags/gentoo/index.html' style='font-size: 101.7910447761194%'>Gentoo(2)</a> <a href='/tags/git/index.html' style='font-size: 103.58208955223881%'>git(4)</a> <a href='/tags/gobject/index.html' style='font-size: 105.3731343283582%'>GObject(6)</a> <a href='/tags/grub/index.html' style='font-size: 100.8955223880597%'>grub(1)</a> <a href='/tags/gtk/index.html' style='font-size: 115.22388059701493%'>gtk(17)</a> <a href='/tags/gulp/index.html' style='font-size: 100.8955223880597%'>gulp(1)</a> <a href='/tags/hash/index.html' style='font-size: 100.8955223880597%'>Hash(1)</a> <a href='/tags/ibus/index.html' style='font-size: 100.8955223880597%'>ibus(1)</a> <a href='/tags/js/index.html' style='font-size: 109.85074626865672%'>js(11)</a> <a href='/tags/linux/index.html' style='font-size: 160.0%'>Linux(67)</a> <a href='/tags/mac/index.html' style='font-size: 100.8955223880597%'>Mac(1)</a> <a href='/tags/mongodb/index.html' style='font-size: 110.74626865671642%'>mongodb(12)</a> <a href='/tags/mysql/index.html' style='font-size: 103.58208955223881%'>mysql(4)</a> <a href='/tags/nginx/index.html' style='font-size: 100.8955223880597%'>nginx(1)</a> <a href='/tags/node/index.html' style='font-size: 100.8955223880597%'>node(1)</a> <a href='/tags/php/index.html' style='font-size: 108.95522388059702%'>php(10)</a> <a href='/tags/ps/index.html' style='font-size: 105.3731343283582%'>PS(6)</a> <a href='/tags/pygame/index.html' style='font-size: 110.74626865671642%'>pygame(12)</a> <a href='/tags/python/index.html' style='font-size: 145.67164179104478%'>python(51)</a> <a href='/tags/qt/index.html' style='font-size: 101.7910447761194%'>Qt(2)</a> <a href='/tags/raspberry-pi/index.html' style='font-size: 100.8955223880597%'>Raspberry pi(1)</a> <a href='/tags/react/index.html' style='font-size: 103.58208955223881%'>react(4)</a> <a href='/tags/redis/index.html' style='font-size: 100.8955223880597%'>redis(1)</a> <a href='/tags/redis/index.html' style='font-size: 100.8955223880597%'>Redis(1)</a> <a href='/tags/ruby/index.html' style='font-size: 129.55223880597015%'>Ruby(33)</a> <a href='/tags/scrapy/index.html' style='font-size: 102.68656716417911%'>Scrapy(3)</a> <a href='/tags/shell/index.html' style='font-size: 100.8955223880597%'>shell(1)</a> <a href='/tags/tq2440/index.html' style='font-size: 104.4776119402985%'>TQ2440(5)</a> <a href='/tags/ubuntu/index.html' style='font-size: 106.26865671641791%'>ubuntu(7)</a> <a href='/tags/usb/index.html' style='font-size: 102.68656716417911%'>USB(3)</a> <a href='/tags/vim/index.html' style='font-size: 123.28358208955224%'>vim(26)</a> <a href='/tags/virtualbox/index.html' style='font-size: 102.68656716417911%'>VirtualBox(3)</a> <a href='/tags/vmware/index.html' style='font-size: 100.8955223880597%'>vmware(1)</a> <a href='/tags/w3m/index.html' style='font-size: 100.8955223880597%'>w3m(1)</a> <a href='/tags/web开发/index.html' style='font-size: 113.43283582089552%'>Web开发(15)</a> <a href='/tags/windows/index.html' style='font-size: 106.26865671641791%'>windows(7)</a> <a href='/tags/wordpress/index.html' style='font-size: 100.8955223880597%'>WordPress(1)</a> <a href='/tags/xcode/index.html' style='font-size: 100.8955223880597%'>Xcode(1)</a> <a href='/tags/xml/index.html' style='font-size: 100.8955223880597%'>xml(1)</a> <a href='/tags/免费/index.html' style='font-size: 100.8955223880597%'>免费(1)</a> <a href='/tags/内核/index.html' style='font-size: 100.8955223880597%'>内核(1)</a> <a href='/tags/匹配算法/index.html' style='font-size: 105.3731343283582%'>匹配算法(6)</a> <a href='/tags/单片机/index.html' style='font-size: 101.7910447761194%'>单片机(2)</a> <a href='/tags/嵌入式/index.html' style='font-size: 100.8955223880597%'>嵌入式(1)</a> <a href='/tags/开源软件/index.html' style='font-size: 108.05970149253731%'>开源软件(9)</a> <a href='/tags/排序算法/index.html' style='font-size: 108.05970149253731%'>排序算法(9)</a> <a href='/tags/文件空间/index.html' style='font-size: 100.8955223880597%'>文件空间(1)</a> <a href='/tags/无线网/index.html' style='font-size: 100.8955223880597%'>无线网(1)</a> <a href='/tags/正则式/index.html' style='font-size: 100.8955223880597%'>正则式(1)</a> <a href='/tags/注册机/index.html' style='font-size: 101.7910447761194%'>注册机(2)</a> <a href='/tags/游戏/index.html' style='font-size: 108.95522388059702%'>游戏(10)</a> <a href='/tags/电脑技巧/index.html' style='font-size: 108.05970149253731%'>电脑技巧(9)</a> <a href='/tags/空间/index.html' style='font-size: 100.8955223880597%'>空间(1)</a> <a href='/tags/算法/index.html' style='font-size: 114.32835820895522%'>算法(16)</a> <a href='/tags/红旗/index.html' style='font-size: 100.8955223880597%'>红旗(1)</a> <a href='/tags/经典语录/index.html' style='font-size: 100.8955223880597%'>经典语录(1)</a> <a href='/tags/网络日志/index.html' style='font-size: 105.3731343283582%'>网络日志(6)</a> <a href='/tags/翻译/index.html' style='font-size: 123.28358208955224%'>翻译(26)</a> <a href='/tags/视频教程/index.html' style='font-size: 108.95522388059702%'>视频教程(10)</a> <a href='/tags/资源分享/index.html' style='font-size: 110.74626865671642%'>资源分享(12)</a> <a href='/tags/转载/index.html' style='font-size: 101.7910447761194%'>转载(2)</a> <a href='/tags/随笔/index.html' style='font-size: 100.8955223880597%'>随笔(1)</a> </span>
</section>
<section>
  <h1>Link</h1>
    <ul id="category-list">
      <li><a target="_blank" title="我的Github" href="https://github.com/wusuopu">@Github</a></li>
      <li><a target="_blank" title="我的微博" href="http://www.weibo.com/u/1768691343">@Weibo</a></li>
      <li><a target="_blank" title="我的Twitter" href="https://twitter.com/longchangjin">@Twitter</a></li>
      <li><a target="_blank" title="我的豆瓣" href="http://www.douban.com/people/lchj/">@Douban</a></li>

      <li><a target="_blank" title="" href="http://www.vimer.cn/">Vimer的程序世界</a></li>
      <li><a target="_blank" title="" href="http://pythoner.net/">python开发者社区</a></li>
      <li><a target="_blank" title="" href="http://simple-is-better.com/">python.cn(news, jobs)</a></li>
      <li><a target="_blank" title="" href="http://gtk.awaysoft.com/">GTK+ 中文社区</a></li>
    </ul>
</section>

  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2016 - 龍昌 -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>
<div style="display:none;"><script src="http://s94.cnzz.com/stat.php?id=1259846&web_id=1259846&show=pic" language="JavaScript"></script></div>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'longchang';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      //dsq.src = '/javascripts/disqus/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>











</body>
</html>
